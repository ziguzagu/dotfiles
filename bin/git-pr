#!/usr/bin/env bash
set -eu

usage() {
    cat <<EOF
Usage:
    git pr setup         - Setup to fetch branches as a pull request number
    git pr find <commit> - Find a pull request including commit hash
    git pr open <commit> - Open a pull request including commit hash
EOF

    exit 1
}

if [ $# -eq 0 ]; then
    usage
fi

case "$1" in
    "setup")
        git config --add remote.origin.fetch +refs/pull/*/head:refs/remotes/origin/pr/*
        ;;
    "find")
        git log --merges --oneline --reverse --ancestry-path $2...HEAD | grep 'Merge pull request #' | head -n 1 |  perl -lne '/#(\d+)/ && print $1'
        ;;
    "open")
        open `hub browse -u`/pull/`git pr find $2`
        ;;
    *)
        usage
        ;;
esac
